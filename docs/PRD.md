# Push Notify 产品需求文档

---

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档名称 | Push Notify 产品需求文档 |
| 文档版本 | V1.0 |
| 创建日期 | 2026年1月19日 |
| 文档作者 | 产品团队 |
| 文档状态 | 初稿 |
| 保密级别 | 内部资料 |

---

## 1 产品概述

### 1.1 项目背景

在现代软件开发流程中，代码提交后的审查环节对于保证代码质量、分享技术知识以及维护项目一致性至关重要。然而，传统的代码审查流程往往存在以下痛点：

首先，代码变更通知不及时。开发人员提交代码后，其他团队成员无法及时获知变更内容，导致审查延迟或遗漏。其次，审查结果分散不统一。代码审查意见散落在各个渠道，难以形成完整的审查记录和知识沉淀。再者，人工审查效率低下。对于大型项目，逐行审查代码耗费大量时间和精力，且容易遗漏关键问题。最后，审查标准不统一。不同审查人员可能有不同的审查标准和关注点，导致代码质量参差不齐。

针对上述问题，我们设计并开发了 Push Notify 智能代码推送通知系统。该系统通过集成代码仓库 webhook，在用户提交代码时自动触发代码审查（CODEVIEW），并利用 AI 技术辅助代码审查，同时将变更内容和审查结果通过多种渠道（钉钉、邮箱等）推送给相关人员。通过智能化的提示词配置和消息模板管理，系统能够帮助团队实现高效、规范的代码审查流程。

### 1.2 产品愿景

打造一款智能化、易用、可扩展的代码推送通知管理平台，帮助开发团队提升代码审查效率，规范代码审查流程，实现代码变更的及时通知和可追溯管理。

### 1.3 产品目标

本产品致力于实现以下核心目标：第一，实现代码提交与审查的自动化衔接，减少人工干预，提升开发效率。第二，提供多渠道推送能力，支持钉钉、邮箱等主流通知方式，确保信息及时触达。第三，集成 AI 代码审查能力，辅助人工审查，发现潜在问题和改进建议。第四，提供灵活的模板配置能力，支持自定义提示词和消息模板，满足不同团队的需求。第五，建立完整的推送记录和日志体系，实现变更追溯和数据分析。

### 1.4 产品范围

#### 1.4.1 包含范围

本产品包含以下功能模块：仓库管理模块，支持代码仓库的配置、webhook 管理和审查规则设置；推送目标管理模块，支持钉钉、邮箱等多种推送方式的配置和管理；推送内容查询模块，提供推送记录的查询、状态追踪和重试功能；AI 模型管理模块，支持 AI 模型接口的配置和调用；用户管理模块，提供用户认证、角色权限管理功能；日志管理模块，记录系统运行日志和用户操作日志；推送消息模板管理模块，支持自定义消息模板和变量替换；提示词管理模块，支持 CODEVIEW 和推送消息的提示词配置。

#### 1.4.2 不包含范围

本产品当前版本不包含以下功能：代码审查的自动化修复建议执行；复杂的代码统计和报表分析功能；与其他 CI/CD 工具的深度集成；移动端应用程序；企业级 SSO 单点登录集成。

---

## 2 用户角色分析

### 2.1 角色定义

本产品定义了以下用户角色，每种角色拥有不同的权限和功能访问范围。

#### 2.1.1 管理员

管理员是系统的最高权限角色，负责系统的整体配置和运维工作。管理员可以访问和管理所有功能模块，包括用户管理、系统配置、数据维护等。管理员负责添加和配置代码仓库、设置推送目标、配置消息模板和管理 AI 模型。管理员还负责监控系统运行状态，处理系统异常和用户反馈。在团队协作中，管理员通常是技术负责人或运维工程师。

#### 2.1.2 普通用户

普通用户是系统的主要使用角色，可以访问被授权的功能模块。普通用户可以查看自己有权访问的仓库信息、推送记录和日志。普通用户可以配置个人的通知偏好设置，但不能修改系统级别的配置。普通用户通常是开发工程师，他们通过系统接收代码变更通知，查看审查结果，并进行相应的代码改进。在团队协作中，普通用户是系统的核心使用者。

#### 2.1.3 访客用户

访客用户是未登录系统的外部用户，只能访问公开信息。访客用户可以查看系统公开的推送记录（如果有配置），但无法访问详细内容和敏感信息。访客用户通常是需要了解项目变更情况的非技术人员，如产品经理、项目经理等。

### 2.2 角色权限矩阵

| 功能模块 | 管理员 | 普通用户 | 访客 |
|---------|--------|---------|------|
| 仓库管理 | 全部权限 | 查看、配置（受限） | 查看（受限） |
| 推送目标管理 | 全部权限 | 查看 | 无 |
| 推送内容查询 | 全部权限 | 查看（受限） | 查看（受限） |
| AI模型管理 | 全部权限 | 查看 | 无 |
| 用户管理 | 全部权限 | 查看个人信息 | 无 |
| 日志管理 | 全部权限 | 查看（受限） | 无 |
| 消息模板管理 | 全部权限 | 查看 | 无 |
| 提示词管理 | 全部权限 | 查看 | 无 |

---

## 3 功能需求详情

### 3.1 仓库管理模块

#### 3.1.1 模块概述

仓库管理模块是系统的核心基础模块，负责代码仓库的配置和管理。通过该模块，用户可以添加、配置和管代码仓库信息，并生成对应的 webhook 地址，实现与代码仓库的集成。当用户向仓库提交代码时，webhook 触发系统自动进行代码审查和推送通知。

#### 3.1.2 功能列表

**功能一：仓库列表查询**

用户进入仓库管理页面后，可以查看已配置的所有代码仓库列表。列表展示内容包括仓库名称、仓库地址、仓库类型、关联的推送目标数量、创建时间和最后更新时间。支持按仓库名称搜索，支持按创建时间排序。每页显示 10 条记录，支持分页浏览。

**功能二：添加仓库**

用户点击「添加仓库」按钮后，弹出添加仓库表单。表单需要填写以下信息：仓库名称（必填，用于标识仓库的显示名称）、仓库地址（必填，Git 仓库的 HTTPS 或 SSH 地址）、仓库类型（必填，支持 GitHub、GitLab、Gitee 等类型）、Access Token（选填，用于访问私有仓库的认证令牌）、Webhook 密钥（选填，用于 webhook 请求的安全性验证）。提交表单后，系统生成唯一的 webhook URL，用户需要将该 URL 配置到代码仓库的 webhook 设置中。

**功能三：仓库详情查看**

用户点击某个仓库条目，可以查看该仓库的详细信息。详情页面包括：仓库基本信息（名称、地址、类型、创建时间）、Webhook 配置信息（Webhook URL、密钥、支持的触发事件）、关联的推送目标列表、该仓库的推送历史统计。

**功能四：仓库编辑**

用户可以对已添加的仓库进行编辑修改。可编辑内容包括仓库名称、仓库地址、仓库类型、Access Token、Webhook 密钥。编辑保存后，系统自动更新相关的 webhook 配置。

**功能五：仓库删除**

用户可以删除不再需要的仓库。删除操作需要二次确认，确认后系统将删除该仓库的所有配置信息（包括 webhook 配置、关联的推送历史记录）。建议删除前先导出相关数据。

**功能六：Webhook 测试**

用户可以点击「测试」按钮，触发一次模拟的 webhook 请求，验证 webhook 配置是否正确。测试结果会显示请求是否成功，以及系统的响应信息。

#### 3.1.3 业务规则

仓库名称在同一系统中必须唯一，不能重复。仓库地址必须是有效的 Git 仓库地址，系统会进行格式验证。Webhook URL 每次生成后保持不变，删除重建会生成新的 URL。仓库删除后，相关的推送历史记录也将被删除。

#### 3.1.4 接口需求

| 接口名称 | 请求方式 | 路径 | 描述 |
|---------|---------|------|------|
| 获取仓库列表 | GET | /api/v1/repos | 支持分页、搜索参数 |
| 获取仓库详情 | GET | /api/v1/repos/:id | 根据仓库ID获取详情 |
| 创建仓库 | POST | /api/v1/repos | 接收仓库配置信息 |
| 更新仓库 | PUT | /api/v1/repos/:id | 更新仓库配置 |
| 删除仓库 | DELETE | /api/v1/repos/:id | 删除仓库及关联数据 |
| 测试Webhook | POST | /api/v1/repos/:id/test | 触发测试 webhook |

### 3.2 推送目标管理模块

#### 3.2.1 模块概述

推送目标管理模块负责配置和管理代码审查结果的推送渠道。系统支持两种主要的推送方式：钉钉推送和邮箱推送。通过该模块，用户可以为不同的仓库或项目配置不同的推送目标，实现精准的信息触达。

#### 3.2.2 功能列表

**功能一：推送目标列表**

用户进入推送目标管理页面后，可以查看已配置的所有推送目标。列表展示内容包括目标名称、推送类型（钉钉/邮箱）、推送范围（全局/指定仓库）、创建时间。支持按目标名称搜索，支持按推送类型筛选。

**功能二：添加钉钉目标**

用户点击「添加推送目标」，选择「钉钉」类型后，需要填写以下信息：目标名称（必填，用于标识推送目标的显示名称）、钉钉群 Access Token（必填，从钉钉群机器人设置中获取）、钉钉机器人 Secret（选填，用于签名验证，增加安全性）、启用状态（必填，设置是否立即启用该推送目标）。填写完成后点击保存，系统会验证 Access Token 的有效性。

**功能三：添加邮箱目标**

用户点击「添加推送目标」，选择「邮箱」类型后，需要填写以下信息：目标名称（必填）、SMTP 服务器地址（必填，如 smtp.example.com）、SMTP 端口（必填，如 587）、发件人邮箱（必填）、发件人密码或授权码（必填）、收件人列表（必填，支持多个邮箱地址，用逗号分隔）。填写完成后点击保存，系统会尝试连接 SMTP 服务器进行验证。

**功能四：推送目标详情**

用户点击某个推送目标条目，可以查看该目标的详细信息。详情页面包括：目标基本信息、配置详情、关联的仓库列表、推送统计信息（总推送次数、成功次数、失败次数）。

**功能五：推送目标编辑**

用户可以对已配置的推送目标进行编辑修改。可编辑内容包括目标名称、配置参数、启用状态。编辑保存后，系统会重新验证配置的有效性。

**功能六：推送目标删除**

用户可以删除不再需要的推送目标。删除操作需要二次确认。删除前需要先解除该目标与仓库的关联，否则删除操作会被阻止。

**功能七：测试推送**

用户可以点击「发送测试」按钮，向该推送目标发送一条测试消息，验证推送配置是否正确。测试消息会包含系统信息，便于用户确认接收效果。

#### 3.2.3 业务规则

同一类型的推送目标名称必须唯一，不同类型可以有相同名称。钉钉机器人的 Access Token 格式必须符合钉钉规范。邮箱配置必须包含有效的 SMTP 服务器地址和端口。收件人邮箱地址必须符合邮箱格式规范，系统会进行格式验证。推送目标可以关联多个仓库，一个仓库也可以关联多个推送目标。

#### 3.2.4 接口需求

| 接口名称 | 请求方式 | 路径 | 描述 |
|---------|---------|------|------|
| 获取推送目标列表 | GET | /api/v1/targets | 支持分页、搜索、筛选 |
| 获取推送目标详情 | GET | /api/v1/targets/:id | 根据ID获取详情 |
| 创建推送目标 | POST | /api/v1/targets | 接收目标配置信息 |
| 更新推送目标 | PUT | /api/v1/targets/:id | 更新目标配置 |
| 删除推送目标 | DELETE | /api/v1/targets/:id | 删除目标及关联 |
| 测试推送 | POST | /api/v1/targets/:id/test | 发送测试消息 |
| 关联仓库 | POST | /api/v1/targets/:id/repos | 关联仓库到目标 |
| 取消关联 | DELETE | /api/v1/targets/:id/repos/:repoId | 取消仓库关联 |

### 3.3 推送内容查询模块

#### 3.3.1 模块概述

推送内容查询模块负责记录和展示所有推送历史，帮助用户追踪推送状态，查询历史推送内容。当推送失败时，用户可以通过该模块进行重试操作。该模块是系统数据追溯和问题排查的重要入口。

#### 3.3.2 功能列表

**功能一：推送记录列表**

用户进入推送内容查询页面后，可以查看所有的推送记录。列表展示内容包括：推送ID、关联仓库名称、推送类型（钉钉/邮箱）、推送状态（成功/失败/待推送）、推送时间、失败原因（如有）。支持按时间范围筛选，支持按仓库名称搜索，支持按推送状态筛选。

**功能二：推送详情查看**

用户点击某条推送记录，可以查看该次推送的详细信息。详情页面包括：推送基本信息（ID、时间、状态）、关联的仓库信息、推送内容详情（消息模板内容、实际发送内容）、CODEVIEW 审查结果、失败原因和错误信息（如有）。

**功能三：推送重试**

对于推送失败的记录，用户可以点击「重试」按钮触发重新推送。重试时系统会使用相同的推送目标和消息内容重新发送。重试操作会生成一条新的推送记录，并记录重试来源。

**功能四：批量操作**

用户可以选择多条推送记录进行批量操作。支持的批量操作包括：批量删除（删除选中的历史记录）、批量重试（对所有失败的记录进行重试）。批量操作需要二次确认。

**功能五：推送统计**

系统提供推送数据的统计概览，包括：今日推送数量、本周推送数量、本月推送数量、推送成功率、失败率统计。统计数据以图表形式展示，便于用户直观了解推送情况。

#### 3.3.3 业务规则

推送记录默认保留 30 天，超期记录自动归档或删除。失败的推送记录保留时间延长至 90 天，便于问题排查。推送重试次数限制为 3 次，超过 3 次仍失败则标记为永久失败。用户只能查看自己有权访问的仓库相关的推送记录。

#### 3.3.4 接口需求

| 接口名称 | 请求方式 | 路径 | 描述 |
|---------|---------|------|------|
| 获取推送记录列表 | GET | /api/v1/pushes | 支持分页、筛选、搜索 |
| 获取推送详情 | GET | /api/v1/pushes/:id | 根据ID获取详情 |
| 重试推送 | POST | /api/v1/pushes/:id/retry | 触发单条重试 |
| 批量重试 | POST | /api/v1/pushes/batch-retry | 批量重试失败记录 |
| 批量删除 | DELETE | /api/v1/pushes/batch-delete | 批量删除记录 |
| 获取推送统计 | GET | /api/v1/pushes/stats | 获取统计数据 |

### 3.4 AI模型管理模块

#### 3.4.1 模块概述

AI 模型管理模块负责配置和管理用于 CODEVIEW 代码审查的 AI 模型接口。通过该模块，用户可以配置不同的 AI 服务提供商、设置模型参数、管理 API 调用凭证。该模块的设计考虑了多模型支持，便于未来扩展和升级。

#### 3.4.2 功能列表

**功能一：模型列表**

用户进入 AI 模型管理页面后，可以查看已配置的所有 AI 模型。列表展示内容包括：模型名称、模型类型（如 GPT-4、Claude）、API 地址、提供商信息、调用次数统计、默认状态。支持按模型名称搜索，支持按提供商筛选。

**功能二：添加模型**

用户点击「添加模型」按钮，弹出添加模型表单。需要填写以下信息：模型名称（必填，用于标识模型）、模型类型（必填，选择预设的模型类型或自定义）、API 地址（必填，AI 服务的 API 端点）、API Key（必填，访问 API 的认证密钥）、超时时间（选填，单位秒，默认 60 秒）。填写完成后点击保存，系统会尝试调用 API 验证凭证有效性。

**功能三：模型参数配置**

用户可以为每个模型配置详细的调用参数，包括：temperature（温度参数，控制生成结果的随机性）、max_tokens（最大生成 token 数）、top_p（核采样参数）、presence_penalty（存在惩罚）、frequency_penalty（频率惩罚）。参数配置采用表单形式，提供合理的默认值和取值范围说明。

**功能四：模型详情查看**

用户点击某个模型条目，可以查看该模型的详细信息。详情页面包括：模型基本信息、配置参数、调用日志摘要、成本统计（如有）。

**功能五：模型编辑**

用户可以对已配置的模型进行编辑修改。可编辑内容包括模型名称、API 地址、API Key、模型参数。API 地址和 API Key 的修改会触发重新验证。

**功能六：设置默认模型**

用户可以将某个模型设置为默认模型。默认模型在 CODEVIEW 时优先使用。同一时刻只能有一个默认模型。

**功能七：模型删除**

用户可以删除不再需要的模型。删除操作需要二次确认。如果该模型正在被某个仓库使用，删除操作会被阻止，需要先解除关联。

**功能八：调用日志查看**

系统记录每次 AI 模型调用的日志，包括：调用时间、输入内容摘要、输出内容摘要、调用耗时、调用状态。用户可以在模型详情页面查看调用日志。

#### 3.4.3 业务规则

系统中必须至少保留一个有效的 AI 模型配置。默认模型不能被删除。API Key 采用加密存储，界面只显示部分字符。模型调用日志保留 7 天，超期自动清理。模型调用失败会触发告警通知管理员。

#### 3.4.4 接口需求

| 接口名称 | 请求方式 | 路径 | 描述 |
|---------|---------|------|------|
| 获取模型列表 | GET | /api/v1/models | 支持分页、搜索 |
| 获取模型详情 | GET | /api/v1/models/:id | 根据ID获取详情 |
| 创建模型 | POST | /api/v1/models | 接收模型配置信息 |
| 更新模型 | PUT | /api/v1/models/:id | 更新模型配置 |
| 删除模型 | DELETE | /api/v1/models/:id | 删除模型 |
| 设置默认模型 | POST | /api/v1/models/:id/default | 设置默认 |
| 获取调用日志 | GET | /api/v1/models/:id/logs | 获取调用日志 |

### 3.5 用户管理模块

#### 3.5.1 模块概述

用户管理模块负责系统的用户认证、权限管理和个人信息管理。该模块采用基于角色的访问控制（RBAC）机制，确保不同角色的用户只能访问其权限范围内的功能和数据。

#### 3.5.2 功能列表

**功能一：用户登录**

用户通过登录页面进入系统，需要提供用户名和密码。登录成功后，系统生成 JWT Token 并返回给客户端，后续请求通过 Token 进行身份认证。登录支持「记住我」功能，延长 Token 有效期。支持登录失败次数限制，超过限制触发账户锁定。

**功能二：用户注册**

新用户可以自行注册账号。需要填写的信息包括：用户名（唯一标识）、邮箱（用于接收通知和密码找回）、密码（需符合复杂度要求）、确认密码。注册成功后系统自动发送验证邮件，用户需要点击验证链接激活账号。

**功能三：用户列表**

管理员进入用户管理页面后，可以查看所有已注册用户。列表展示内容包括：用户名、邮箱、角色、状态（激活/锁定）、最后登录时间、创建时间。支持按用户名搜索，支持按角色筛选。

**功能四：用户创建**

管理员可以手动创建新用户账号。创建时需要填写用户名、邮箱、密码，选择角色。创建成功后，系统发送欢迎邮件给用户，用户首次登录后需要修改密码。

**功能五：用户编辑**

管理员可以编辑用户信息，包括：邮箱、角色、状态。普通用户可以在个人设置中修改自己的邮箱和密码。

**功能六：密码管理**

用户可以在个人设置中修改自己的密码，需要提供原密码进行验证。管理员可以重置用户密码，重置后用户下次登录需要设置新密码。密码必须符合复杂度要求：最少 8 位，包含大小写字母和数字。

**功能七：角色分配**

管理员可以为用户分配不同的角色。角色决定用户的权限范围。支持一个用户拥有多个角色，权限取并集。

**功能八：账户状态管理**

管理员可以锁定或解锁用户账户。锁定状态的用户无法登录系统，但账户数据保留。锁定超过 30 天未解锁的账户，系统自动发送提醒通知管理员。

**功能九：个人设置**

用户可以在个人设置页面管理自己的偏好设置，包括：通知偏好（接收通知的渠道、接收时间段）、界面语言、时区设置。

#### 3.5.3 业务规则

用户名必须唯一，长度 3-20 位，支持字母、数字、下划线。邮箱格式必须有效，且在同一系统中唯一。密码必须符合复杂度要求，定期强制更换（可选配置）。普通用户不能修改自己的角色。用户登录 Token 有效期为 24 小时，支持刷新机制。连续登录失败 5 次后，账户锁定 30 分钟。

#### 3.5.4 接口需求

| 接口名称 | 请求方式 | 路径 | 描述 |
|---------|---------|------|------|
| 用户登录 | POST | /api/v1/auth/login | 接收凭据，返回Token |
| 用户注册 | POST | /api/v1/auth/register | 创建新用户 |
| 获取当前用户 | GET | /api/v1/auth/me | 获取当前用户信息 |
| 修改密码 | PUT | /api/v1/auth/password | 修改密码 |
| 获取用户列表 | GET | /api/v1/users | 管理员功能 |
| 创建用户 | POST | /api/v1/users | 管理员功能 |
| 获取用户详情 | GET | /api/v1/users/:id | 管理员功能 |
| 更新用户 | PUT | /api/v1/users/:id | 管理员功能 |
| 删除用户 | DELETE | /api/v1/users/:id | 管理员功能 |
| 重置密码 | POST | /api/v1/users/:id/reset-password | 管理员功能 |
| 获取个人设置 | GET | /api/v1/settings | 获取当前用户设置 |
| 更新个人设置 | PUT | /api/v1/settings | 更新用户设置 |

### 3.6 日志管理模块

#### 3.6.1 模块概述

日志管理模块负责记录和展示系统的运行日志、用户操作日志和 AI 调用日志。该模块为系统运维、问题排查和安全审计提供数据支持。

#### 3.6.2 功能列表

**功能一：系统运行日志**

系统自动记录运行过程中的关键事件，包括：服务启动和停止、数据库连接状态、缓存操作、任务调度执行、异常错误信息。日志级别分为：DEBUG（调试信息）、INFO（普通信息）、WARN（警告）、ERROR（错误）。用户可以按日志级别、时间范围进行筛选查看。

**功能二：用户操作日志**

系统记录用户的操作行为，包括：登录登出、配置变更、数据操作（增删改）、权限变更等。日志内容包括：操作用户、操作时间、操作类型、操作对象、操作详情、客户端 IP。用户可以查看自己的操作记录，管理员可以查看所有用户的操作记录。

**功能三：AI调用日志**

系统记录每次 AI 模型调用的详细信息，包括：调用时间、模型名称、输入内容摘要、输出内容摘要、调用耗时、调用状态、错误信息（如有）。日志用于分析 AI 审查效果和排查调用问题。

**功能四：日志搜索**

用户可以通过关键词、时间范围、日志类型等条件搜索日志。支持全文搜索，可以搜索日志内容中的关键字。搜索结果高亮显示匹配的关键词。

**功能五：日志导出**

用户可以将日志导出为 CSV 或 JSON 格式文件。导出时可以选择时间范围和日志类型。导出文件有大小限制，单次导出不超过 10000 条记录。

**功能六：日志统计**

系统提供日志数据的统计概览，包括：各类日志数量趋势、操作频率统计、错误分布分析。用户可以通过统计图表了解系统运行状况。

#### 3.6.3 业务规则

系统运行日志保留 7 天，AI 调用日志保留 7 天，用户操作日志保留 30 天。日志文件按日期分割存储，每日自动压缩归档。ERROR 级别的日志会触发告警通知管理员。用户只能查看自己有权访问的日志范围。日志导出需要管理员权限。

#### 3.6.4 接口需求

| 接口名称 | 请求方式 | 路径 | 描述 |
|---------|---------|------|------|
| 获取系统日志 | GET | /api/v1/logs/system | 获取运行日志 |
| 获取操作日志 | GET | /api/v1/logs/operations | 获取操作日志 |
| 获取AI调用日志 | GET | /api/v1/logs/ai-calls | 获取AI调用日志 |
| 搜索日志 | GET | /api/v1/logs/search | 综合搜索 |
| 导出日志 | GET | /api/v1/logs/export | 导出日志文件 |
| 获取日志统计 | GET | /api/v1/logs/stats | 获取统计数据 |

### 3.7 推送消息模板管理模块

#### 3.7.1 模块概述

推送消息模板管理模块负责配置和管理不同渠道、不同场景的消息模板。通过灵活的模板配置，用户可以自定义推送消息的内容格式，实现个性化的通知展示。模板支持变量替换，能够动态插入代码变更信息和审查结果。

#### 3.7.2 功能列表

**功能一：模板列表**

用户进入消息模板管理页面后，可以查看已配置的所有模板。列表展示内容包括：模板名称、模板类型（钉钉/邮件）、模板场景（代码提交通知/审查结果通知）、状态（启用/禁用）、最后修改时间。支持按模板名称搜索，支持按类型和场景筛选。

**功能二：创建模板**

用户点击「新建模板」按钮，选择模板类型和场景后，填写以下信息：模板名称（必填，用于标识模板）、模板类型（必填，选择钉钉或邮件）、模板场景（必填，选择适用的通知场景）、模板标题（必填，消息的标题）、模板内容（必填，消息正文，支持变量替换）、备注（选填，模板说明）。钉钉模板支持 Markdown 格式，邮件模板支持 HTML 格式。

**功能三：模板预览**

用户在编辑模板时，可以点击「预览」按钮查看模板渲染效果。预览时会使用模拟数据填充变量，展示最终的推送效果。预览支持切换不同渠道查看样式差异。

**功能四：模板测试**

用户可以点击「测试」按钮，向指定的推送目标发送一条测试消息，验证模板在实际推送中的效果。测试消息会使用模拟数据进行变量填充。

**功能五：模板编辑**

用户可以对已创建的模板进行编辑修改。编辑界面包含创建时的所有字段。编辑保存后，系统会记录版本历史。

**功能六：模板版本管理**

系统自动保存模板的版本历史。用户可以查看模板的历史版本，可以回滚到指定版本。版本历史保留最近 10 个版本。

**功能七：模板启用禁用**

用户可以禁用不需要的模板，禁用的模板不会在推送时被使用。禁用的模板仍可以查看和编辑，也可以重新启用。每个场景只能有一个启用的模板。

**功能八：模板删除**

用户可以删除不再需要的模板。删除操作需要二次确认。系统默认模板不能删除，只能编辑。

#### 3.7.3 业务规则

模板名称在同一类型和场景下必须唯一。模板内容必须有实际内容，不能为空。每个场景只能有一个启用的模板。系统预设的模板不能删除，但可以修改。模板变量使用 `{{.变量名}}` 格式，系统提供可用的变量列表。

#### 3.7.4 模板变量说明

| 变量名 | 说明 | 适用场景 |
|-------|------|---------|
| {{.RepoName}} | 仓库名称 | 全部 |
| {{.RepoUrl}} | 仓库地址 | 全部 |
| {{.CommitId}} | 提交ID | 全部 |
| {{.CommitMsg}} | 提交信息 | 全部 |
| {{.Author}} | 提交者 | 全部 |
| {{.Branch}} | 分支名称 | 全部 |
| {{.ChangedFiles}} | 变更文件列表 | 全部 |
| {{.FileCount}} | 变更文件数量 | 全部 |
| {{.CodeViewResult}} | 代码审查结果 | 审查结果通知 |
| {{.CodeViewIssues}} | 审查问题列表 | 审查结果通知 |
| {{.ReviewTime}} | 审查时间 | 审查结果通知 |

#### 3.7.5 接口需求

| 接口名称 | 请求方式 | 路径 | 描述 |
|---------|---------|------|------|
| 获取模板列表 | GET | /api/v1/templates | 支持分页、筛选 |
| 获取模板详情 | GET | /api/v1/templates/:id | 根据ID获取详情 |
| 创建模板 | POST | /api/v1/templates | 接收模板信息 |
| 更新模板 | PUT | /api/v1/templates/:id | 更新模板配置 |
| 删除模板 | DELETE | /api/v1/templates/:id | 删除模板 |
| 获取版本历史 | GET | /api/v1/templates/:id/versions | 获取历史版本 |
| 回滚版本 | POST | /api/v1/templates/:id/rollback | 回滚到指定版本 |
| 模板预览 | POST | /api/v1/templates/preview | 预览渲染效果 |
| 模板测试 | POST | /api/v1/templates/:id/test | 发送测试消息 |
| 启用禁用 | PUT | /api/v1/templates/:id/status | 更新启用状态 |

### 3.8 提示词管理模块

#### 3.8.1 模块概述

提示词管理模块负责配置和管理 AI 代码审查（CODEVIEW）以及推送消息生成所使用的提示词模板。通过精心设计的提示词，用户可以引导 AI 按照团队的标准和规范进行代码审查，确保审查结果的一致性和专业性。

#### 3.8.2 功能列表

**功能一：提示词列表**

用户进入提示词管理页面后，可以查看已配置的所有提示词。列表展示内容包括：提示词名称、提示词类型（CODEVIEW/推送消息）、使用场景、关联模型、最后修改时间。支持按类型筛选，支持按名称搜索。

**功能二：创建CODEVIEW提示词**

用户点击「新建提示词」，选择「CODEVIEW」类型后，填写以下信息：提示词名称（必填）、使用场景（选填，如代码规范检查/安全检查/性能优化）、适用语言（选填，如 Go/Java/Python）、提示词内容（必填，核心的提示词模板）。提示词内容支持变量替换，变量包括文件内容、文件名、代码差异等。

**功能三：创建推送消息提示词**

用户点击「新建提示词」，选择「推送消息」类型后，填写以下信息：提示词名称（必填）、目标类型（钉钉/邮件）、提示词内容（必填）。推送消息提示词用于根据 CODEVIEW 结果生成推送消息的详细描述。

**功能四：提示词编辑**

用户可以对已创建的提示词进行编辑修改。编辑界面包含创建时的所有字段。编辑保存后生成新的版本。

**功能五：提示词测试**

用户可以点击「测试」按钮，使用示例代码或数据测试提示词效果。测试会调用 AI 模型，使用当前提示词生成结果，展示给用户查看是否符合预期。

**功能六：提示词版本管理**

系统自动保存提示词的版本历史。用户可以查看历史版本，可以回滚到指定版本。版本历史保留最近 10 个版本。

**功能七：提示词关联模型**

用户可以为提示词指定关联的 AI 模型。不同的提示词可以使用不同的模型，以达到最佳的审查效果。

**功能八：提示词导入导出**

用户可以将提示词导出为 JSON 格式文件，方便在不同环境间迁移。也可以从文件导入提示词配置。导入时会检查格式正确性和变量完整性。

#### 3.8.3 业务规则

提示词名称必须唯一。提示词内容必须有实际内容，长度不能超过 4000 字符。CODEVIEW 提示词必须包含 `{{.FileContent}}` 或 `{{.DiffContent}}` 变量。系统预设的提示词不能删除，但可以修改。每个场景可以有多个提示词，用户可以切换使用。

#### 3.8.4 CODEVIEW提示词变量说明

| 变量名 | 说明 | 示例 |
|-------|------|------|
| {{.FileName}} | 文件名 | main.go |
| {{.FileContent}} | 完整文件内容 | （文件的所有代码） |
| {{.DiffContent}} | 代码差异内容 | （git diff 输出） |
| {{.Language}} | 编程语言 | Go |
| {{.RepoName}} | 仓库名称 | push_notify |
| {{.Branch}} | 分支名称 | main |
| {{.CommitMsg}} | 提交信息 | fix: 修复登录bug |

#### 3.8.5 接口需求

| 接口名称 | 请求方式 | 路径 | 描述 |
|---------|---------|------|------|
| 获取提示词列表 | GET | /api/v1/prompts | 支持分页、筛选 |
| 获取提示词详情 | GET | /api/v1/prompts/:id | 根据ID获取详情 |
| 创建提示词 | POST | /api/v1/prompts | 接收提示词信息 |
| 更新提示词 | PUT | /api/v1/prompts/:id | 更新提示词配置 |
| 删除提示词 | DELETE | /api/v1/prompts/:id | 删除提示词 |
| 获取版本历史 | GET | /api/v1/prompts/:id/versions | 获取历史版本 |
| 回滚版本 | POST | /api/v1/prompts/:id/rollback | 回滚到指定版本 |
| 提示词测试 | POST | /api/v1/prompts/:id/test | 测试提示词效果 |
| 导出提示词 | GET | /api/v1/prompts/:id/export | 导出提示词 |
| 导入提示词 | POST | /api/v1/prompts/import | 导入提示词 |

---

## 4 非功能需求

### 4.1 性能需求

#### 4.1.1 响应时间要求

系统各功能的响应时间应满足以下要求：页面加载时间不超过 3 秒（首次加载除外）；API 接口响应时间不超过 500 毫秒（不含外部服务调用）；推送消息发送时间不超过 2 秒（不含 AI 模型调用）；AI 代码审查响应时间不超过 30 秒（根据代码量可能更长）。

#### 4.1.2 并发处理能力

系统应能够支持以下并发指标：支持同时 100 个用户在线操作；支持同时处理 50 个 webhook 请求；支持同时调用 10 个 AI 模型请求；推送消息支持批量处理，单批次最多 100 条。

#### 4.1.3 数据处理能力

系统应能够处理以下数据规模：单个仓库支持最多 1000 个推送目标；单次推送支持最多 50 个收件人（邮箱）；单个仓库历史推送记录保留 10000 条；单次 CODEVIEW 支持最多 50 个文件。

### 4.2 安全性需求

#### 4.2.1 认证授权

用户认证采用 JWT Token 机制，Token 有效期 24 小时，支持刷新机制。密码采用 bcrypt 算法加密存储，严禁明文保存。实现登录失败锁定机制，连续失败 5 次锁定 30 分钟。管理操作需要二次验证（可选配置）。

#### 4.2.2 数据安全

敏感数据（API Key、密码等）采用加密存储。数据传输采用 HTTPS 加密。实现数据访问日志记录，可追溯操作行为。定期自动备份数据库，保留最近 7 天的备份。

#### 4.2.3 接口安全

所有 API 接口需要身份认证（除公开接口外）。实现请求频率限制，防止恶意攻击。输入参数进行严格校验和过滤。防止 SQL 注入、XSS 攻击等常见安全问题。

#### 4.2.4 Webhook安全

支持 Webhook 密钥验证，确保请求来源可信。支持 IP 白名单配置（可选）。支持签名验证（钉钉等平台）。

### 4.3 可用性需求

#### 4.3.1 系统可用性

系统应达到 99.5% 的可用性指标（每月停机时间不超过 3.6 小时）。计划性维护应提前 24 小时通知用户。系统应具备故障自动恢复能力。

#### 4.3.2 容错处理

AI 服务不可用时，系统仍可推送原始变更通知，不阻断推送流程。数据库连接失败时，系统返回友好错误提示，不影响其他功能。Redis 不可用时，系统降级使用本地缓存，确保核心功能可用。

#### 4.3.3 数据可靠性

推送失败的消息自动重试 3 次，间隔分别为 1 分钟、5 分钟、30 分钟。重试仍失败的记录标记为失败，保留记录供用户手动处理。关键操作具有事务保护，确保数据一致性。

### 4.4 可维护性需求

#### 4.4.1 日志记录

系统日志分为四个级别：DEBUG、INFO、WARN、ERROR。日志格式统一包含：时间戳、日志级别、模块名称、请求ID、日志内容。ERROR 级别日志触发告警通知管理员。日志文件按日期分割，便于问题排查。

#### 4.4.2 配置管理

系统配置支持环境变量和配置文件两种方式。敏感配置支持加密存储。配置变更支持热加载（部分配置）。提供配置导出和导入功能。

#### 4.4.3 监控告警

系统运行状态监控包括：CPU、内存、磁盘使用率。关键指标监控包括：API 响应时间、推送成功率、AI 调用成功率。异常情况自动触发告警，支持邮件和钉钉通知。

### 4.5 可扩展性需求

#### 4.5.1 模块扩展

系统采用模块化设计，便于新增功能模块。新增推送渠道只需实现标准接口，无需修改核心代码。提示词和模板支持自定义扩展。

#### 4.5.2 水平扩展

后端服务支持多实例部署，实现负载均衡。Redis 支持集群模式，满足高并发需求。数据库支持读写分离，提升查询性能。

---

## 5 数据字典

### 5.1 核心数据表

#### 5.1.1 用户表（users）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|-------|-------|------|
| id | integer | - | N | auto | 主键 |
| username | varchar | 50 | N | - | 用户名，唯一 |
| email | varchar | 100 | N | - | 邮箱，唯一 |
| password | varchar | 255 | N | - | 加密后的密码 |
| role | varchar | 20 | N | 'user' | 角色：admin/user |
| status | varchar | 20 | N | 'active' | 状态：active/locked |
| last_login_at | datetime | - | Y | - | 最后登录时间 |
| created_at | datetime | - | N | now() | 创建时间 |
| updated_at | datetime | - | N | now() | 更新时间 |

#### 5.1.2 仓库表（repos）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|-------|-------|------|
| id | integer | - | N | auto | 主键 |
| name | varchar | 100 | N | - | 仓库名称 |
| url | varchar | 500 | N | - | 仓库地址 |
| type | varchar | 50 | N | - | 仓库类型 |
| access_token | varchar | 255 | Y | - | 访问令牌 |
| webhook_url | varchar | 500 | N | - | Webhook URL |
| webhook_secret | varchar | 100 | Y | - | Webhook 密钥 |
| model_id | integer | - | Y | - | 关联AI模型 |
| status | varchar | 20 | N | 'active' | 状态 |
| created_at | datetime | - | N | now() | 创建时间 |
| updated_at | datetime | - | N | now() | 更新时间 |

#### 5.1.3 推送目标表（targets）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|-------|-------|------|
| id | integer | - | N | auto | 主键 |
| name | varchar | 100 | N | - | 目标名称 |
| type | varchar | 20 | N | - | 类型：dingtalk/email |
| config | text | - | N | - | JSON配置 |
| scope | varchar | 20 | N | 'global' | 范围：global/repo |
| status | varchar | 20 | N | 'active' | 状态 |
| created_at | datetime | - | N | now() | 创建时间 |
| updated_at | datetime | - | N | now() | 更新时间 |

#### 5.1.4 推送记录表（pushes）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|-------|-------|------|
| id | integer | - | N | auto | 主键 |
| repo_id | integer | - | N | - | 仓库ID |
| target_id | integer | - | N | - | 推送目标ID |
| template_id | integer | - | Y | - | 模板ID |
| commit_id | varchar | 50 | N | - | 提交ID |
| commit_msg | varchar | 500 | N | - | 提交信息 |
| status | varchar | 20 | N | 'pending' | 状态 |
| content | text | - | N | - | 推送内容 |
| error_msg | text | - | Y | - | 错误信息 |
| retry_count | integer | - | N | 0 | 重试次数 |
| pushed_at | datetime | - | Y | - | 推送时间 |
| created_at | datetime | - | N | now() | 创建时间 |

#### 5.1.5 消息模板表（templates）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|-------|-------|------|
| id | integer | - | N | auto | 主键 |
| name | varchar | 100 | N | - | 模板名称 |
| type | varchar | 20 | N | - | 类型：dingtalk/email |
| scene | varchar | 50 | N | - | 场景 |
| title | varchar | 200 | N | - | 模板标题 |
| content | text | - | N | - | 模板内容 |
| is_default | boolean | - | N | false | 是否默认 |
| status | varchar | 20 | N | 'active' | 状态 |
| version | integer | - | N | 1 | 版本号 |
| created_at | datetime | - | N | now() | 创建时间 |
| updated_at | datetime | - | N | now() | 更新时间 |

#### 5.1.6 提示词表（prompts）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|-------|-------|------|
| id | integer | - | N | auto | 主键 |
| name | varchar | 100 | N | - | 提示词名称 |
| type | varchar | 20 | N | - | 类型：codeview/message |
| scene | varchar | 50 | Y | - | 场景 |
| language | varchar | 50 | Y | - | 适用语言 |
| content | text | - | N | - | 提示词内容 |
| model_id | integer | - | Y | - | 关联模型 |
| version | integer | - | N | 1 | 版本号 |
| created_at | datetime | - | N | now() | 创建时间 |
| updated_at | datetime | - | N | now() | 更新时间 |

#### 5.1.7 AI模型表（models）

| 字段名 | 类型 | 长度 | 允许空 | 默认值 | 说明 |
|-------|------|------|-------|-------|------|
| id | integer | - | N | auto | 主键 |
| name | varchar | 100 | N | - | 模型名称 |
| type | varchar | 50 | N | - | 模型类型 |
| api_url | varchar | 500 | N | - | API地址 |
| api_key | varchar | 255 | N | - | API密钥 |
| params | text | - | Y | - | JSON参数配置 |
| is_default | boolean | - | N | false | 是否默认 |
| call_count | integer | - | N | 0 | 调用次数 |
| status | varchar | 20 | N | 'active' | 状态 |
| created_at | datetime | - | N | now() | 创建时间 |
| updated_at | datetime | - | N | now() | 更新时间 |

### 5.2 枚举值说明

| 字段 | 枚举值 | 说明 |
|-----|-------|------|
| role | admin | 管理员 |
| | user | 普通用户 |
| type | dingtalk | 钉钉 |
| | email | 邮箱 |
| status | active | 启用 |
| | inactive | 禁用 |
| | locked | 锁定 |
| scope | global | 全局 |
| | repo | 指定仓库 |
| scene | commit_notify | 代码提交通知 |
| | review_notify | 审查结果通知 |
| prompt_type | codeview | CODEVIEW提示词 |
| | message | 推送消息提示词 |

---

## 6 风险分析

### 6.1 技术风险

**风险一：AI服务依赖**

系统核心功能 CODEVIEW 依赖于外部 AI 服务。如果 AI 服务提供商出现故障、价格变动或接口变更，将直接影响系统的正常使用。

**应对措施**：支持配置多个 AI 模型，可动态切换；提示词设计为通用格式，便于迁移到不同 AI 服务；提供降级方案，AI 不可用时仍可推送原始变更信息；监控 AI 服务状态，异常时及时告警。

**风险二：Webhook 安全性**

Webhook 接口暴露在公网，可能遭受恶意攻击或伪造请求。

**应对措施**：支持 Webhook 密钥验证；支持 IP 白名单配置；实现请求频率限制；记录详细的 webhook 请求日志。

**风险三：数据丢失**

数据库故障或误操作可能导致数据丢失。

**应对措施**：定期自动备份数据库，保留多个历史备份；关键操作增加确认机制；实现数据的软删除机制，便于恢复；建立完善的日志记录，支持数据追溯。

### 6.2 业务风险

**风险一：用户接受度**

用户可能习惯于现有的代码审查流程，对新系统的接受度不高。

**应对措施**：提供完善的培训和文档支持；界面设计简洁易用，降低学习成本；收集用户反馈，持续优化产品体验；分阶段推广，逐步培养用户习惯。

**风险二：推送消息过多**

如果配置不当，可能产生大量推送消息，造成用户困扰。

**应对措施**：提供消息聚合功能，减少推送频率；支持用户级别的消息免打扰设置；提供推送统计，帮助管理员优化配置；智能过滤无意义的变更。

**风险三：审查结果不准确**

AI 代码审查的结果可能存在误判或遗漏。

**应对措施**：提供人工复核机制，AI 结果仅供参考；提示词持续优化，提高审查准确性；记录审查结果和人工反馈，用于模型改进；明确告知用户 AI 审查的局限性。

### 6.3 运营风险

**风险一：成本控制**

AI 服务调用可能产生较高成本，如果使用不当可能超出预算。

**应对措施**：提供调用统计和成本分析功能；支持配置调用频率限制；记录详细的调用日志，便于成本核算；提供成本预警机制。

**风险二：服务可用性**

系统故障可能导致代码变更通知延迟或丢失。

**应对措施**：部署高可用架构，实现故障转移；建立完善的监控告警体系；制定应急预案，明确故障处理流程；定期进行故障演练。

---

## 7 里程碑规划

### 7.1 版本规划总览

| 版本 | 名称 | 目标日期 | 主要内容 |
|-----|------|---------|---------|
| V1.0 | 基础功能版 | 2026年2月 | 核心功能上线，支持基础仓库管理和推送 |
| V1.1 | 体验优化版 | 2026年3月 | UI优化，性能提升，Bug修复 |
| V1.2 | AI增强版 | 2026年4月 | AI模型管理优化，提示词功能增强 |
| V2.0 | 企业版 | 2026年6月 | 企业级功能，支持私有化部署 |

### 7.2 V1.0 基础功能版

**目标日期**：2026年2月底

**交付内容**：

第一阶段（第一周至第二周）完成后端基础框架搭建和数据库设计，包括：Gin 框架项目结构和路由设计；数据库表结构创建和初始化；用户认证模块实现（登录、注册、Token 管理）；基础 API 框架和中间件（日志、限流、认证）。

第二阶段（第三周至第四周）完成仓库管理和推送目标模块，包括：仓库的增删改查和 webhook 功能；钉钉推送集成和配置；邮箱推送集成和配置；推送目标和仓库的关联关系。

第三阶段（第五周至第六周）完成推送记录和日志模块，包括：推送记录的存储和查询；推送状态追踪和重试功能；系统日志和操作日志记录；日志查询和导出功能。

第四阶段（第六周至第七周）完成前端界面开发，包括：Vue3 项目初始化和基础组件；仓库管理页面；推送目标管理页面；推送记录查询页面。

**验收标准**：完成所有核心功能的开发和测试；通过集成测试，验证端到端流程；文档齐全，包括 API 文档和用户手册；性能测试通过，满足性能需求。

### 7.3 V1.1 体验优化版

**目标日期**：2026年3月底

**交付内容**：

第一，用户体验优化，包括：界面交互优化，提升操作流畅度；响应式布局适配，支持移动端访问；加载状态和错误提示优化。

第二，性能优化，包括：API 接口响应时间优化；数据库查询优化；前端首屏加载优化。

第三，功能增强，包括：消息模板管理功能；简化提示词配置流程。

第四，Bug修复和问题解决，包括：修复测试中发现的 Bug；解决用户反馈的问题。

### 7.4 V1.2 AI增强版

**目标日期**：2026年4月底

**交付内容**：

第一，AI 模型管理增强，包括：支持更多 AI 服务提供商；模型参数配置优化；调用日志和成本统计。

第二，提示词功能增强，包括：CODEVIEW 提示词模板管理；推送消息提示词模板；提示词测试和效果预览；提示词版本管理。

第三，代码审查功能增强，包括：多文件审查支持；审查结果格式化展示；审查建议采纳跟踪。

第四，分析和统计功能，包括：推送数据统计报表；AI 调用效果分析；团队审查效率统计。

### 7.5 V2.0 企业版

**目标日期**：2026年6月底

**交付内容**：

第一，企业级功能，包括：多团队/多项目支持；细粒度的权限控制；审计日志和合规报告。

第二，私有化部署支持，包括：容器化部署方案；配置中心和支持文件配置；离线版本支持。

第三，集成能力增强，包括：企业微信集成；飞书集成；更多 CI/CD 工具集成。

第四，高级功能，包括：智能聚合推送；自定义审查规则；审查结果自动关联需求。

---

## 8 附录

### 8.1 术语表

| 术语 | 说明 |
|-----|------|
| CODEVIEW | 代码审查，指对代码进行检查和评估的过程 |
| Webhook | Webhook 是一种基于 HTTP 回调的机制，用于在特定事件发生时通知外部系统 |
| JWT | JSON Web Token，一种用于身份认证的开放标准 |
| RBAC | Role-Based Access Control，基于角色的访问控制 |
| AI Model | 人工智能模型，用于辅助代码审查的机器学习模型 |
| Prompt | 提示词，用于指导 AI 模型生成特定输出的文本指令 |

### 8.2 参考资料

- Vue3 官方文档：https://vuejs.org/
- Gin 框架官方文档：https://gin-gonic.com/
- GORM 官方文档：https://gorm.io/
- naive-ui 官方文档：https://www.naiveui.com/
- 钉钉机器人开发文档

### 8.3 修订记录

| 版本 | 日期 | 修订人 | 修订内容 |
|-----|------|-------|---------|
| V1.0 | 2026-01-19 | 产品团队 | 初始版本 |
